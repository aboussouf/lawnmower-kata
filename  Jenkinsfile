pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh 'mvn clean install -DskipTests'
            }
        }

        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }

        stage('Create Merge Request') {
            steps {
                script {
                    // Get the current branch name
                    def branchName = env.GIT_BRANCH.replace("origin/", "")

                    // Check if the branch is not 'main'
                    if (branchName != 'main') {
                        gitlab(
                            apiUrl: 'https://gitlab.com/api/v4',
                            projectId: '45568229',
                            privateToken: 'glpat-sLH-xai1Tqz1ByF7xAsH', // Replace with your GitLab access token
                            mergeRequest: [
                                title: "Merge Request for ${branchName}",
                                sourceBranch: branchName,
                                targetBranch: 'main',
                                labels: 'jenkins'
                            ]
                        )
                    } else {
                        echo "This is the main branch. No merge request will be created."
                    }
                }
            }
        }
    }
}